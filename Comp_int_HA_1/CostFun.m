function [cost, grad] = CostFun(joints, H_base, links, H_target)
  
  grad = zeros(length(joints), 1);
 
  joints = normalizeAngle(joints);
  
  H_pred = H_base * Rz(joints(1)) * Tx(0.312) * Ry(joints(2)) * Tz(links(1)) * ...
    Ry(joints(3)) * Tz(0.225) * Tx(links(2)) * Rx(joints(4)) * ...
    Ry(joints(5)) * Rx(joints(6)) * Tx(0.215);
   
  cost = -trace(H_pred(1:3, 1:3)'*H_target(1:3, 1:3)) + ...
         norm(H_pred(1:3,4)-H_target(1:3,4))^2;
  
  H_pred = H_base * Rdz(joints(1)) * Tx(0.312) * Ry(joints(2)) * Tz(links(1)) * ...
    Ry(joints(3)) * Tz(0.225) * Tx(links(2)) * Rx(joints(4)) * ...
    Ry(joints(5)) * Rx(joints(6)) * Tx(0.215);
    
  grad(1) = -trace(H_pred(1:3, 1:3)'*H_target(1:3, 1:3)) + ...
         norm(H_pred(1:3,4)-H_target(1:3,4));
         
  H_pred = H_base * Rz(joints(1)) * Tx(0.312) * Rdy(joints(2)) * Tz(links(1)) * ...
    Ry(joints(3)) * Tz(0.225) * Tx(links(2)) * Rx(joints(4)) * ...
    Ry(joints(5)) * Rx(joints(6)) * Tx(0.215);
    
  grad(2) = -trace(H_pred(1:3, 1:3)'*H_target(1:3, 1:3)) + ...
         norm(H_pred(1:3,4)-H_target(1:3,4));
      
  H_pred = H_base * Rz(joints(1)) * Tx(0.312) * Ry(joints(2)) * Tz(links(1)) * ...
    Rdy(joints(3)) * Tz(0.225) * Tx(links(2)) * Rx(joints(4)) * ...
    Ry(joints(5)) * Rx(joints(6)) * Tx(0.215);
    
  grad(3) = -trace(H_pred(1:3, 1:3)'*H_target(1:3, 1:3)) + ...
         norm(H_pred(1:3,4)-H_target(1:3,4));
  
  H_pred = H_base * Rz(joints(1)) * Tx(0.312) * Ry(joints(2)) * Tz(links(1)) * ...
    Ry(joints(3)) * Tz(0.225) * Tx(links(2)) * Rdx(joints(4)) * ...
    Ry(joints(5)) * Rx(joints(6)) * Tx(0.215);
    
  grad(4) = -trace(H_pred(1:3, 1:3)'*H_target(1:3, 1:3)) + ...
         norm(H_pred(1:3,4)-H_target(1:3,4));
         
  H_pred = H_base * Rz(joints(1)) * Tx(0.312) * Ry(joints(2)) * Tz(links(1)) * ...
    Ry(joints(3)) * Tz(0.225) * Tx(links(2)) * Rx(joints(4)) * ...
    Rdy(joints(5)) * Rx(joints(6)) * Tx(0.215);
    
  grad(5) = -trace(H_pred(1:3, 1:3)'*H_target(1:3, 1:3)) + ...
         norm(H_pred(1:3,4)-H_target(1:3,4));
         
  H_pred = H_base * Rz(joints(1)) * Tx(0.312) * Ry(joints(2)) * Tz(links(1)) * ...
    Ry(joints(3)) * Tz(0.225) * Tx(links(2)) * Rx(joints(4)) * ...
    Ry(joints(5)) * Rdx(joints(6)) * Tx(0.215);
    
  grad(6) = -trace(H_pred(1:3, 1:3)'*H_target(1:3, 1:3)) + ...
         norm(H_pred(1:3,4)-H_target(1:3,4));
         
  end